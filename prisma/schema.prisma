generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  name        String
  email       String       @unique
  password    String
  userType    UserType     @default(MANAGER)
  isSuperAdmin Boolean     @default(false)
  accountId   String?      // ID da conta/empresa do usuário
  tenantId    String?      // ID do tenant (organização)
  adminId     String?      // ID do administrador (para gerentes)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attendances Attendance[]
  createdLeads Lead[]      @relation("UserCreatedLeads")
  managedAttendants Attendant[] @relation("ManagerAttendants")
  adminAttendants Attendant[] @relation("AdminAttendants")
  managedManagers User[]     @relation("AdminManagers")
  admin       User?        @relation("AdminManagers", fields: [adminId], references: [id])
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([adminId])
}

enum UserType {
  ADMIN
  MANAGER
}


model Lead {
  id          String       @id @default(uuid())
  name        String
  email       String?
  phone       String?
  source      String?
  status      String       @default("novo")
  notes       String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  deletedBy   String?
  columnId    String?
  position    Int          @default(0)
  attendantId String?
  createdBy   String?      // ID do usuário que criou o lead
  column      Column?      @relation(fields: [columnId], references: [id])
  attendant   Attendant?   @relation("AttendantLeads", fields: [attendantId], references: [id])
  creator     User?        @relation("UserCreatedLeads", fields: [createdBy], references: [id])
  attendances Attendance[]
  ratings     Rating[]

  @@index([columnId])
  @@index([attendantId])
  @@index([createdBy])
  @@index([deletedAt])
}

model Column {
  id        String   @id @default(uuid())
  title     String
  position  Int      @default(0)
  color     String   @default("#6B7280") // Cor padrão cinza
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  deletedBy String?
  leads     Lead[]

  @@index([deletedAt])
}

model Integration {
  id        String   @id @default(uuid())
  name      String
  type      String
  config    String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attendance {
  id          String      @id @default(uuid())
  leadId      String
  userId      String?
  type        String      // "call", "email", "meeting", "whatsapp", "note", "follow_up"
  subject     String?
  description String?     @db.Text
  status      String      @default("pending") // "pending", "completed", "cancelled"
  priority    String      @default("medium") // "low", "medium", "high", "urgent"
  scheduledAt DateTime?
  completedAt DateTime?
  duration    Int?        // em minutos
  outcome     String?     // "successful", "no_answer", "callback", "not_interested", "converted"
  nextAction  String?     @db.Text
  tags        String?     // tags separadas por vírgula
  attachments String?     @db.Text // URLs ou paths dos anexos
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  lead        Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([scheduledAt])
  @@index([status])
}

model Position {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  attendants  Attendant[]
}

model Function {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  attendants  Attendant[]
}

model Department {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  attendants  Attendant[]
}

model Attendant {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique
  password     String?     // senha para login do atendente
  phone        String?
  cpf          String?     @unique
  positionId   String?
  functionId   String?
  departmentId String?
  managerId    String?     // ID do gerente responsável
  adminId      String?     // ID do administrador (hierarquia)
  startTime    String      // horário de início (formato HH:mm)
  endTime      String      // horário de fim (formato HH:mm)
  workDays     String      // dias da semana (ex: "1,2,3,4,5" para seg-sex)
  isActive     Boolean     @default(true)
  canLogin     Boolean     @default(false) // se o atendente pode fazer login
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  position     Position?   @relation(fields: [positionId], references: [id])
  function     Function?   @relation(fields: [functionId], references: [id])
  department   Department? @relation(fields: [departmentId], references: [id])
  manager      User?       @relation("ManagerAttendants", fields: [managerId], references: [id])
  admin        User?       @relation("AdminAttendants", fields: [adminId], references: [id])
  leads        Lead[]      @relation("AttendantLeads")
  ratings      Rating[]

  @@index([positionId])
  @@index([functionId])
  @@index([departmentId])
  @@index([managerId])
  @@index([adminId])
}

model Rating {
  id          String    @id @default(uuid())
  attendantId String
  leadId      String?
  score       Int       // pontuação de 1 a 5
  type        String    // "elogio", "critica", "avaliacao"
  comment     String?   @db.Text
  ratedBy     String?   // quem fez a avaliação
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  attendant   Attendant @relation(fields: [attendantId], references: [id], onDelete: Cascade)
  lead        Lead?     @relation(fields: [leadId], references: [id])

  @@index([attendantId])
  @@index([leadId])
  @@index([type])
}

model Tenant {
  id          String   @id @default(uuid())
  name        String   // Nome da organização (ex: "ADLUX", "LAU")
  slug        String   @unique // Slug para URL (ex: "crmadlux", "crmlau")
  domain      String?  @unique // Domínio personalizado (ex: "crm.adlux.com.br")
  email       String?  // Email do administrador do tenant
  password    String?  // Senha do administrador do tenant
  logo        String?  // URL/caminho da logo do tenant
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  settings    SystemSettings[]

  @@index([slug])
  @@index([domain])
}

model SystemSettings {
  id          String   @id @default(uuid())
  tenantId    String   // Cada tenant tem suas próprias configurações
  key         String   // Chave da configuração (ex: "system_name", "smtp_host")
  value       String   @db.Text // Valor da configuração
  type        String   @default("string") // Tipo: string, number, boolean, json
  category    String   @default("general") // Categoria: general, smtp, appearance
  description String?  // Descrição da configuração
  isPublic    Boolean  @default(false) // Se pode ser acessada publicamente
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([category])
}
